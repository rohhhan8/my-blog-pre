import{u as I,b as O,r as s,j as a,h as D,B as P,i as L,k as J,l as R}from"./index-0685d0f1.js";import{I as h}from"./Input-41c5edce.js";import{S as Y}from"./Spinner-1fd68904.js";const G=()=>{var N,S;const{currentUser:t,updateUserProfile:U}=I(),b=O(),[o,u]=s.useState({display_name:"",bio:"",profession:"",gender:"",location:"",website:"",avatar_url:""}),[C,m]=s.useState(!0),[y,x]=s.useState(!1),[v,l]=s.useState(""),[w,p]=s.useState(""),[k,E]=s.useState(null),[j,g]=s.useState("");s.useEffect(()=>{(async()=>{try{if(m(!0),!t){l("You must be logged in to edit your profile"),m(!1);return}const r=localStorage.getItem("pendingProfileUpdate");if(r)try{const e=JSON.parse(r);console.log("Found pending profile update:",e),window.confirm("We found profile changes that were not saved due to an authentication issue. Would you like to use these changes?")?(u(e),e.avatar_url&&g(e.avatar_url),p("Your previous changes have been loaded. Click Save Changes to try updating your profile again.")):localStorage.removeItem("pendingProfileUpdate")}catch(e){console.error("Error parsing pending profile update:",e),localStorage.removeItem("pendingProfileUpdate")}try{const e=await L();e.auth_warning&&(console.log("Auth warning from server:",e.auth_warning),l("Authentication warning: "+e.auth_warning+" Your changes will be saved locally until you log out and back in.")),(!r||!JSON.parse(r))&&(u({display_name:e.display_name||"",bio:e.bio||"",profession:e.profession||"",gender:e.gender||"",location:e.location||"",website:e.website||"",avatar_url:e.avatar_url||""}),e.avatar_url&&g(e.avatar_url))}catch(e){console.error("Error fetching profile:",e),(!r||!JSON.parse(r))&&(e.response&&(e.response.status===404||e.response.status===403)?(console.log(`Profile not found or auth failed (${e.response.status}), initializing with defaults`),u({display_name:t.displayName||"",bio:"",profession:"",gender:"",location:"",website:"",avatar_url:t.photoURL||""}),t.photoURL&&g(t.photoURL),e.response.status===403&&l("Authentication issue detected. Your changes will be saved locally until you log out and back in.")):l("Failed to load profile. Please try again later."))}}finally{m(!1)}})()},[t]);const n=i=>{const{name:r,value:e}=i.target;u(d=>({...d,[r]:e}))},A=i=>{const r=i.target.files[0];if(r){E(r);const e=new FileReader;e.onloadend=()=>{g(e.result)},e.readAsDataURL(r)}},F=async i=>{i.preventDefault();try{x(!0),l(""),p(""),console.log("Starting profile update process..."),console.log("Current profile data:",o);let r={...o};if(k)try{console.log("Uploading avatar file...");const e=await J(k);console.log("Avatar uploaded successfully:",e),r.avatar_url=e}catch(e){console.error("Error uploading avatar:",e),l("Failed to upload avatar. Profile update will continue without the new avatar.")}r.user||(r.user=t.uid),!r.display_name&&t.displayName&&(r.display_name=t.displayName),console.log("Sending profile update with data:",r);try{const e=await R(r);console.log("Profile update result:",e),localStorage.removeItem("pendingProfileUpdate");const d=t.displayName||o.display_name;localStorage.setItem("currentUserProfile",JSON.stringify({old_name:d,display_name:r.display_name,timestamp:new Date().toISOString()}));try{const c=Object.keys(localStorage).filter(f=>f.startsWith("author_"));for(const f of c){const _=f.replace("author_","");_===d&&(localStorage.setItem(f,JSON.stringify({display_name:r.display_name,timestamp:new Date().toISOString()})),console.log(`Updated cached author: ${_} -> ${r.display_name}`))}}catch(c){console.error("Error updating cached authors:",c)}if(r.display_name&&t)try{await U(r.display_name,r.avatar_url||null),console.log("Firebase displayName updated to:",r.display_name)}catch(c){console.error("Error updating Firebase displayName:",c)}p("Profile updated successfully!"),setTimeout(()=>{b("/profile")},1500)}catch(e){console.error("Error updating profile:",e),e.response&&e.response.status===403?(l("Authentication error. Please try logging out and back in, then try again."),localStorage.setItem("pendingProfileUpdate",JSON.stringify(r)),p("Your changes have been saved locally and will be applied when you log back in.")):l(`Failed to update profile: ${e.message||"Unknown error"}`)}}catch(r){console.error("Unexpected error in profile update:",r),l(`An unexpected error occurred: ${r.message||"Unknown error"}`)}finally{x(!1)}};return C?a.jsx(D,{}):a.jsx("div",{className:"min-h-screen bg-blog-bg dark:bg-black page-content",children:a.jsx("div",{className:"max-w-3xl mx-auto px-4 sm:px-6 lg:px-8",children:a.jsxs("div",{className:"bg-white dark:bg-black rounded-lg shadow-md border border-gray-200 dark:border-gray-700 overflow-hidden",children:[a.jsxs("div",{className:"p-6 md:p-8 border-b border-gray-200 dark:border-gray-700",children:[a.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Edit Profile"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Update your profile information"})]}),a.jsxs("form",{onSubmit:F,className:"p-6 md:p-8 space-y-6",children:[w&&a.jsx("div",{className:"bg-green-100 dark:bg-green-900 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-300 px-4 py-3 rounded",children:w}),v&&a.jsx("div",{className:"bg-red-100 dark:bg-red-900 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 px-4 py-3 rounded",children:v}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-gray-700 dark:text-gray-300 mb-2",children:"Profile Picture"}),a.jsxs("div",{className:"flex items-center space-x-6",children:[a.jsx("div",{className:"w-24 h-24 rounded-full bg-gray-900 dark:bg-white flex items-center justify-center text-white dark:text-gray-900 text-4xl font-medium overflow-hidden",children:j?a.jsx("img",{src:j,alt:"Avatar Preview",className:"w-full h-full object-cover"}):(((N=o.display_name)==null?void 0:N.charAt(0))||((S=t==null?void 0:t.displayName)==null?void 0:S.charAt(0))||"U").toUpperCase()}),a.jsxs("div",{children:[a.jsxs("label",{className:"block",children:[a.jsx("span",{className:"sr-only",children:"Choose profile photo"}),a.jsx("input",{type:"file",accept:"image/*",onChange:A,className:`block w-full text-sm text-gray-500 dark:text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded file:border-0
                        file:text-sm file:font-medium
                        file:bg-gray-100 file:text-gray-700
                        dark:file:bg-gray-800 dark:file:text-gray-300
                        hover:file:bg-gray-200 dark:hover:file:bg-gray-700`})]}),a.jsx("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-400",children:"PNG, JPG, GIF up to 10MB"})]})]})]}),a.jsx(h,{id:"display_name",name:"display_name",label:"Display Name",value:o.display_name,onChange:n,placeholder:"How you want to be known on the site"}),a.jsx(h,{id:"profession",name:"profession",label:"Profession",value:o.profession,onChange:n,placeholder:"e.g. Software Developer, Student, Writer"}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:"gender",className:"block text-gray-700 dark:text-gray-300 mb-2",children:"Gender"}),a.jsxs("select",{id:"gender",name:"gender",value:o.gender,onChange:n,className:"w-full px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-black border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-white",children:[a.jsx("option",{value:"",children:"Prefer not to say"}),a.jsx("option",{value:"Male",children:"Male"}),a.jsx("option",{value:"Female",children:"Female"}),a.jsx("option",{value:"Non-binary",children:"Non-binary"}),a.jsx("option",{value:"Other",children:"Other"})]})]}),a.jsx(h,{id:"location",name:"location",label:"Location",value:o.location,onChange:n,placeholder:"e.g. New York, USA"}),a.jsx(h,{id:"website",name:"website",label:"Website",value:o.website,onChange:n,placeholder:"https://yourwebsite.com"}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:"bio",className:"block text-gray-700 dark:text-gray-300 mb-2",children:"Bio"}),a.jsx("textarea",{id:"bio",name:"bio",value:o.bio,onChange:n,rows:5,className:"w-full px-3 py-2 text-gray-900 dark:text-white bg-white dark:bg-black border border-gray-300 dark:border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-900 dark:focus:ring-white",placeholder:"Tell us about yourself..."})]}),a.jsxs("div",{className:"flex justify-end space-x-4",children:[a.jsx(P,{type:"button",variant:"secondary",onClick:()=>b("/profile"),disabled:y,children:"Cancel"}),a.jsx(P,{type:"submit",variant:"primary",disabled:y,children:y?a.jsx(Y,{size:"sm"}):"Save Changes"})]})]})]})})})};export{G as default};
